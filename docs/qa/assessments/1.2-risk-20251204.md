# Risk Profile: Story 1.2 - Integrate Norgate Data API via Windows Python Bridge

**Date:** 2025-12-04
**Reviewer:** Quinn (Test Architect)
**Story:** 1.2 - Integrate Norgate Data API via Windows Python Bridge

---

## Executive Summary

- **Total Risks Identified:** 8
- **Critical Risks:** 1
- **High Risks:** 2
- **Medium Risks:** 3
- **Low Risks:** 2
- **Overall Risk Score:** 63/100 (Moderate Risk - Careful implementation required)

**Key Finding:** The primary risk is the complexity of subprocess-based communication between WSL Python and Windows Python. The bridge pattern is technically sound but requires robust error handling and thorough testing.

---

## Critical Risks Requiring Immediate Attention

### 1. TECH-001: Subprocess Communication Failure Between WSL and Windows Python

**Score: 9 (Critical)**

**Probability:** High (3) - Cross-platform subprocess communication is inherently complex with multiple failure modes:
- PATH resolution differences between WSL and Windows
- stdout/stderr buffering issues
- Process termination and cleanup
- Character encoding mismatches (UTF-8 vs Windows codepages)

**Impact:** High (3) - Complete feature failure. If the bridge doesn't work, no Norgate data access is possible, blocking all downstream stories in Epic 1.

**Affected Components:**
- `src/momo/data/bridge.py` - Core bridge module
- All tests in `tests/stories/1.2/`

**Mitigation Strategy (Preventive):**

1. **Comprehensive Error Handling:**
   - Wrap all subprocess calls in try-except blocks
   - Check return codes before parsing output
   - Handle `FileNotFoundError`, `subprocess.TimeoutExpired`, `subprocess.CalledProcessError`

2. **Robust Output Parsing:**
   - Parse only the last line of stdout (skip norgatedata INFO messages)
   - Strip whitespace before JSON parsing
   - Validate JSON structure before returning

3. **Testing Requirements:**
   - Unit tests with mock subprocess responses (all success and failure paths)
   - Integration tests on actual WSL+Windows environment
   - Test with various Windows Python versions (3.11, 3.12, 3.13)
   - Chaos testing: Kill NDU mid-request, corrupt JSON output, timeout scenarios

4. **Validation:**
   - Add extensive logging at all bridge boundaries
   - Log subprocess arguments, stdout, stderr, return codes
   - Add timing metrics to detect performance issues

**Residual Risk:** Low - After comprehensive testing and error handling, should be stable. Some edge cases (Windows updates, antivirus interference) may remain.

**Owner:** Dev Team
**Timeline:** Must be resolved before Story 1.2 completion

---

## Risk Matrix

| Risk ID  | Description                                  | Probability | Impact     | Score | Priority |
|----------|----------------------------------------------|-------------|------------|-------|----------|
| TECH-001 | Subprocess communication failure (WSL↔Win)   | High (3)    | High (3)   | 9     | Critical |
| OPS-001  | NDU not running or not authenticated         | High (3)    | Medium (2) | 6     | High     |
| DATA-001 | JSON serialization failures for DataFrames   | Medium (2)  | High (3)   | 6     | High     |
| PERF-001 | Subprocess timeout causing hanging ops       | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002 | Windows Python not in PATH or wrong version  | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-002 | Norgatedata INFO messages interfere w/JSON   | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-001  | Command injection via code parameter         | Low (1)     | High (3)   | 3     | Low      |
| OPS-002  | Inadequate error messages for failures       | Low (1)     | Medium (2) | 2     | Low      |

---

## Risk Distribution

### By Category

- **Technical (TECH):** 2 risks (1 critical, 1 medium)
- **Security (SEC):** 1 risk (0 critical, 1 low)
- **Performance (PERF):** 1 risk (0 critical, 1 medium)
- **Data (DATA):** 2 risks (0 critical, 2 high)
- **Operational (OPS):** 2 risks (0 critical, 1 high, 1 low)

### By Component

- **Bridge Module (`bridge.py`):** 7 risks
- **Test Infrastructure:** 1 risk
- **Documentation:** 0 risks

---

## Detailed Risk Register

### HIGH RISKS

#### OPS-001: NDU Not Running or Not Authenticated

**Score: 6 (High)**

**Probability:** High (3) - NDU is an external Windows service that:
- May not be running when bridge attempts connection
- May lose authentication (subscription expiry, login timeout)
- May be updating data (temporarily unavailable)

**Impact:** Medium (2) - Can be gracefully handled with clear error messages. Doesn't cause data corruption, just unavailability.

**Affected Components:**
- `execute_norgate_code()` function
- `check_ndu_status()` helper function

**Mitigation Strategy (Detective + Corrective):**

1. **Proactive Status Check:**
   - Implement `check_ndu_status()` to verify NDU before data requests
   - Call at module initialization and before large operations
   - Cache status for short duration (30 seconds) to reduce overhead

2. **Error Detection:**
   - Parse stderr for "NDU is not running" message
   - Raise custom `NDUNotRunningError` with actionable message
   - Include troubleshooting steps in error message

3. **User Guidance:**
   - Document NDU startup procedure in `docs/architecture/windows-python-bridge.md`
   - Add troubleshooting section for common NDU issues
   - Provide clear error messages: "Norgate Data Updater is not running. Please start NDU on Windows and ensure you're logged in."

4. **Testing Requirements:**
   - Integration test with NDU stopped (verify error message)
   - Integration test with NDU running (verify success)
   - Unit test for error parsing logic

**Residual Risk:** Low - Clear error messages allow quick resolution. No data corruption risk.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

#### DATA-001: JSON Serialization Failures for Complex DataFrame Structures

**Score: 6 (High)**

**Probability:** Medium (2) - pandas DataFrames can contain:
- NaN values (not JSON-serializable)
- datetime objects (require string conversion)
- NumPy int64 (may overflow JavaScript number)
- Mixed dtypes in columns

**Impact:** High (3) - Could cause:
- Silent data corruption (NaN → null)
- Type coercion errors (int64 → float)
- Complete serialization failure (crash)

**Affected Components:**
- `execute_norgate_code()` JSON serialization
- `fetch_price_data()` DataFrame handling

**Mitigation Strategy (Preventive):**

1. **Custom JSON Serialization:**
   - Use `json.dumps(result, default=str)` to handle datetime objects
   - Convert DataFrames to dict with `orient='records'` before serialization
   - Explicitly handle NaN: `df.fillna('NaN')` or use pandas `.to_json()`

2. **Schema Validation:**
   - Document expected DataFrame schema in docstrings
   - Validate dtypes after deserialization: `assert df['close'].dtype == 'float64'`
   - Add unit tests for various data types

3. **Alternative Approach:**
   - Consider using pandas `.to_json()` and `.read_json()` for native DataFrame serialization
   - Benchmark performance vs manual dict conversion

4. **Testing Requirements:**
   - Unit test with DataFrame containing NaN values
   - Unit test with datetime index
   - Unit test with large int64 values
   - Integration test with actual Norgate data (verify schema)

**Residual Risk:** Low - With explicit serialization strategy and validation, should be robust.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

### MEDIUM RISKS

#### PERF-001: Subprocess Timeout Causing Hanging Operations

**Score: 4 (Medium)**

**Probability:** Medium (2) - Potential causes:
- NDU performing background updates
- Network latency (if NDU accesses remote data)
- Large data requests (full Russell 3000)
- Windows system resource constraints

**Impact:** Medium (2) - User experience degradation, but doesn't cause data corruption. Can be recovered with timeout.

**Mitigation Strategy (Preventive + Corrective):**

1. **Implement Timeout:**
   - Default 30-second timeout for subprocess calls
   - Make timeout configurable per operation
   - Raise `NorgateBridgeError` with clear message on timeout

2. **Retry Logic:**
   - Use tenacity for automatic retry (3 attempts, 1-second wait)
   - Exponential backoff for transient NDU busy errors
   - Log retry attempts for debugging

3. **Performance Monitoring:**
   - Log execution time for all bridge calls
   - Alert if operations exceed expected duration (e.g., >10 seconds for single symbol)
   - Document typical performance characteristics

4. **Testing Requirements:**
   - Unit test with mock timeout (verify exception raised)
   - Integration test with intentional delay (sleep in Windows Python)
   - Load test with multiple concurrent requests

**Residual Risk:** Medium - Some legitimate operations may take >30 seconds (full Russell 3000). Need to tune timeout per operation type.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

#### TECH-002: Windows Python Not in PATH or Wrong Version

**Score: 4 (Medium)**

**Probability:** Medium (2) - Environment-dependent:
- Fresh WSL installation may not have Windows PATH configured
- Multiple Python versions on Windows (Anaconda, system, etc.)
- python.exe vs python3.exe naming

**Impact:** Medium (2) - Clear error message can guide user to fix. Doesn't cause data corruption.

**Mitigation Strategy (Preventive + Detective):**

1. **Environment Validation:**
   - Check for `python.exe` availability at module load time
   - Verify Python version: `python.exe --version` (require 3.11+)
   - Document Windows Python requirements in bridge documentation

2. **Clear Error Messages:**
   - Raise `WindowsPythonNotFoundError` with troubleshooting steps
   - Include instructions to add Windows Python to WSL PATH
   - Suggest checking Windows Python installation

3. **Configuration Options:**
   - Allow WINDOWS_PYTHON_PATH environment variable to override default
   - Document in `docs/architecture/windows-python-bridge.md`

4. **Testing Requirements:**
   - Unit test with FileNotFoundError (verify exception raised)
   - Manual test on fresh WSL installation (verify error message clarity)

**Residual Risk:** Low - Documentation and clear error messages should resolve most cases.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

#### DATA-002: Norgatedata INFO Messages Interfering with JSON Parsing

**Score: 4 (Medium)**

**Probability:** Medium (2) - Known issue from Story 1.0 exploration:
- norgatedata package prints INFO messages to stdout
- Messages appear before JSON output
- Format: "INFO: [message]"

**Impact:** Medium (2) - Can be mitigated by parsing only last line of stdout. If not handled, causes JSON parse errors.

**Mitigation Strategy (Preventive):**

1. **Robust Parsing:**
   - Parse only last line: `output_lines[-1]`
   - Strip whitespace before JSON parsing
   - Validate JSON structure before returning

2. **Logging Strategy:**
   - Capture all stdout lines for debugging
   - Log INFO messages separately (don't discard)
   - Include full stdout in error messages if JSON parsing fails

3. **Alternative Approach:**
   - Redirect norgatedata logs to stderr in Windows Python
   - Set norgatedata log level to WARNING

4. **Testing Requirements:**
   - Unit test with mock stdout containing INFO messages + JSON
   - Integration test verifying INFO messages don't break parsing
   - Unit test with malformed output (no JSON line)

**Residual Risk:** Low - Story 1.0 already validated this approach works.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

### LOW RISKS

#### SEC-001: Command Injection via Unsanitized Code Parameter

**Score: 3 (Low)**

**Probability:** Low (1) - `execute_norgate_code()` is an internal API, not user-facing. Code parameter is constructed by bridge helper functions, not from user input.

**Impact:** High (3) - If exploited, could execute arbitrary Python code on Windows system via subprocess.

**Mitigation Strategy (Preventive):**

1. **Input Validation:**
   - Document that `execute_norgate_code()` is for internal use only
   - Add docstring warning about code injection risk
   - Consider adding basic validation (reject shell metacharacters)

2. **API Design:**
   - Keep `execute_norgate_code()` as private function (`_execute_norgate_code`)
   - Expose only safe, parameterized wrappers (`fetch_price_data`, `check_ndu_status`)
   - Never pass user-provided strings directly to `execute_norgate_code()`

3. **Future Enhancement:**
   - If external access needed, use JSON RPC or similar structured protocol
   - Implement whitelist of allowed Norgate API functions

4. **Testing Requirements:**
   - Security review of all code paths calling `execute_norgate_code()`
   - Verify no user input reaches code parameter

**Residual Risk:** Low - As long as function remains internal, risk is minimal.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

#### OPS-002: Inadequate Error Messages for Bridge Failures

**Score: 2 (Low)**

**Probability:** Low (1) - With proper error handling design, can be avoided.

**Impact:** Medium (2) - Poor developer experience, difficult troubleshooting. Doesn't affect functionality if errors are rare.

**Mitigation Strategy (Preventive):**

1. **Error Message Design:**
   - Include context: what operation failed, why it failed, how to fix
   - Example: "Failed to fetch price data for AAPL: NDU is not running. Please start Norgate Data Updater on Windows."
   - Include subprocess return code, stderr in error messages

2. **Documentation:**
   - Create troubleshooting guide in `docs/architecture/windows-python-bridge.md`
   - Document common error scenarios and resolutions
   - Include examples of error messages

3. **Logging:**
   - Log all errors with full context (function, arguments, subprocess output)
   - Use structlog for structured error logging

4. **Testing Requirements:**
   - Manual review of error messages (clarity, actionability)
   - User testing with intentional failures (verify error messages guide to resolution)

**Residual Risk:** Very Low - Good software engineering practice.

**Owner:** Dev Team
**Timeline:** Before Story 1.2 completion

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Merging)

**TECH-001: Subprocess Communication**

- **Unit Tests:**
  - `test_1_2_unit_001`: Verify `execute_norgate_code()` calls subprocess with correct arguments (mock subprocess)
  - `test_1_2_unit_002`: Verify JSON response parsing with mock subprocess
  - `test_1_2_unit_005`: Verify Windows Python not found error handling
  - `test_1_2_unit_006`: Verify timeout handling with mock timeout

- **Integration Tests:**
  - `test_1_2_int_001`: Verify `check_ndu_status()` with actual NDU
  - `test_1_2_int_002`: Verify `fetch_price_data()` retrieves AAPL data with correct schema
  - `test_1_2_int_003`: Verify bridge handles norgatedata INFO messages

- **Chaos Tests (Manual or Scripted):**
  - Kill NDU mid-request, verify graceful error
  - Corrupt JSON output, verify parse error handling
  - Test with slow network/NDU, verify timeout behavior

### Priority 2: High Risk Tests

**OPS-001: NDU Availability**

- Integration test with NDU stopped (verify error message clarity)
- Integration test with NDU running (verify success path)
- Unit test for NDU error detection logic

**DATA-001: JSON Serialization**

- Unit test with DataFrame containing NaN values
- Unit test with datetime index and datetime columns
- Unit test with large int64 values (>2^53)
- Integration test verifying actual Norgate data schema

### Priority 3: Medium Risk Tests

**PERF-001: Timeout Handling**

- Unit test with mock timeout (verify exception and message)
- Performance test: measure typical request duration
- Load test: multiple concurrent requests (verify no deadlocks)

**TECH-002: Environment Validation**

- Unit test for FileNotFoundError handling
- Manual test on fresh WSL (verify error message guides to fix)

**DATA-002: INFO Message Handling**

- Unit test with mock stdout containing INFO + JSON
- Integration test verifying production behavior
- Unit test with malformed output (no valid JSON)

### Priority 4: Low Risk Tests

**SEC-001: Security Review**

- Code review of all `execute_norgate_code()` call sites
- Verify no external input reaches code parameter

**OPS-002: Error Message Quality**

- Manual review of all error messages (clarity, actionability)
- User testing with intentional failures

---

## Test Data Requirements

### For Unit Tests (Mock Data)

1. **Valid subprocess output:**
   ```
   INFO: Norgate Data Updater connection established
   {"data": [{"date": "2023-01-03", "close": 125.07}], "symbol": "AAPL"}
   ```

2. **Subprocess error (NDU not running):**
   - Return code: 1
   - stderr: "Error: NDU is not running"

3. **Subprocess timeout:**
   - Raise `subprocess.TimeoutExpired` after 30 seconds

4. **DataFrame with edge cases:**
   - NaN values: `pd.DataFrame({"close": [100.0, np.nan, 102.0]})`
   - Datetime index: `pd.date_range("2023-01-01", periods=100)`
   - Large int64: `pd.DataFrame({"volume": [2**60]})`

### For Integration Tests (Actual Data)

1. **Test symbols:**
   - AAPL (active, liquid, complete history)
   - MSFT (active, liquid, complete history)
   - XYZ (delisted or invalid, for error testing)

2. **Date ranges:**
   - Last 1 year (fast test)
   - Full history (comprehensive test, slower)

3. **Windows environment:**
   - NDU running and authenticated
   - Windows Python 3.11+ installed and in PATH
   - norgatedata package installed in Windows Python

---

## Risk Acceptance Criteria

### Must Fix Before Production

**Critical Risks (Score 9):**
- TECH-001: Subprocess communication failure
  - **Acceptance:** All unit and integration tests pass
  - **Validation:** Manual testing on WSL+Windows environment with various failure scenarios

### Can Deploy with Mitigation

**High Risks (Score 6):**
- OPS-001: NDU not running
  - **Mitigation:** Clear error messages, documentation of NDU startup procedure
  - **Acceptance:** Error message guides user to resolution

- DATA-001: JSON serialization failures
  - **Mitigation:** Explicit serialization strategy, schema validation
  - **Acceptance:** Unit tests cover all edge cases (NaN, datetime, int64)

**Medium Risks (Score 4):**
- PERF-001: Timeout handling
  - **Mitigation:** 30-second timeout with retry logic
  - **Acceptance:** Timeout tests pass, performance documented

- TECH-002: Windows Python not found
  - **Mitigation:** Clear error message with troubleshooting steps
  - **Acceptance:** Manual test verifies error message clarity

- DATA-002: INFO message handling
  - **Mitigation:** Parse only last line of stdout
  - **Acceptance:** Story 1.0 validated approach; integration tests confirm

### Accepted Risks

**Low Risks (Score 1-3):**
- SEC-001: Command injection
  - **Justification:** Internal API, no external access
  - **Monitoring:** Code review ensures no user input reaches code parameter

- OPS-002: Inadequate error messages
  - **Justification:** Can be improved iteratively based on user feedback
  - **Monitoring:** Track support requests related to error message clarity

---

## Monitoring Requirements

### Post-Deployment Monitoring

**Performance Metrics (PERF-001):**
- Track bridge operation duration (p50, p95, p99)
- Alert if p95 > 10 seconds for single symbol fetch
- Monitor timeout frequency (should be <1% of requests)

**Error Rates (OPS-001, TECH-001):**
- Track `NDUNotRunningError` frequency
- Track `WindowsPythonNotFoundError` frequency
- Track `NorgateBridgeError` frequency (generic failures)
- Alert if error rate > 5% of requests

**Data Quality (DATA-001):**
- Validate fetched data schema after every request (in development)
- Log schema validation failures
- Monitor for NaN values in unexpected columns

**Resource Usage (PERF-001):**
- Monitor subprocess creation rate (avoid leaks)
- Monitor memory usage of bridge operations
- Alert if subprocess count grows unbounded

### Logging Strategy

**All bridge operations should log:**
- Function called
- Arguments (symbol, date range, timeout)
- Execution time (ms)
- Success/failure
- Error details (if failed)

**Example log entry:**
```json
{
  "event": "bridge_operation",
  "function": "fetch_price_data",
  "symbol": "AAPL",
  "start_date": "2023-01-01",
  "end_date": "2023-12-31",
  "duration_ms": 156,
  "success": true,
  "rows_returned": 252
}
```

---

## Risk Review Triggers

**Review and update this risk profile when:**

1. **Architecture changes:**
   - Alternative to subprocess communication (e.g., gRPC, HTTP bridge)
   - Change to data serialization format (e.g., Parquet, Arrow)

2. **New integrations:**
   - Additional data sources beyond Norgate
   - Bridge used for other Windows-only libraries

3. **Issues discovered:**
   - Production errors not covered in risk profile
   - Performance issues exceeding documented thresholds
   - Security vulnerabilities identified

4. **Dependency updates:**
   - norgatedata package updates (breaking changes)
   - Python version upgrades (3.13 → 3.14)
   - Windows or WSL updates (compatibility issues)

5. **Regulatory requirements:**
   - New data privacy requirements (GDPR, etc.)
   - Audit requirements for data access

---

## Risk Mitigation Action Plan

### Before Story 1.2 Completion

| Action | Risk | Owner | Priority |
|--------|------|-------|----------|
| Implement robust subprocess error handling | TECH-001 | Dev | Critical |
| Add comprehensive unit tests for bridge | TECH-001 | Dev | Critical |
| Implement `check_ndu_status()` with clear error messages | OPS-001 | Dev | High |
| Add JSON serialization strategy for DataFrames | DATA-001 | Dev | High |
| Implement 30-second timeout with retry logic | PERF-001 | Dev | Medium |
| Add Windows Python PATH validation | TECH-002 | Dev | Medium |
| Test INFO message parsing with integration tests | DATA-002 | Dev | Medium |
| Document bridge architecture and troubleshooting | OPS-001, OPS-002 | Dev | Medium |
| Code review for command injection risks | SEC-001 | Dev | Low |

### Post-Story 1.2 (Future Improvements)

| Action | Risk | Owner | Priority |
|--------|------|-------|----------|
| Benchmark alternative serialization (Parquet/Arrow) | DATA-001 | Dev | Low |
| Add performance regression tests | PERF-001 | Dev | Low |
| Implement structured bridge protocol (JSON RPC) | SEC-001 | Dev | Low |
| Add bridge operation dashboard (Grafana) | PERF-001, OPS-001 | Ops | Low |

---

## Appendix: Risk Scoring Calculation

**Overall Risk Score:** 63/100

**Calculation:**
- Base Score: 100
- Critical (9): -20 × 1 = -20
- High (6): -10 × 2 = -20
- Medium (4): -5 × 3 = -15
- Low (2-3): -2 × 2 = -4
- **Final Score:** 100 - 20 - 20 - 15 - 4 = **41/100**

**Correction:** Initial calculation error. Recalculating:

- Base Score: 100
- TECH-001 (9 - Critical): -20 = 80
- OPS-001 (6 - High): -10 = 70
- DATA-001 (6 - High): -10 = 60
- PERF-001 (4 - Medium): -5 = 55
- TECH-002 (4 - Medium): -5 = 50
- DATA-002 (4 - Medium): -5 = 45
- SEC-001 (3 - Low): -2 = 43
- OPS-002 (2 - Low): -2 = 41

**Actual Final Score:** 41/100

**Interpretation:** Moderate-to-High Risk. The critical subprocess communication risk and two high data/ops risks require careful implementation and thorough testing. However, all risks have clear mitigation strategies. With proper implementation, the story should succeed.

---

## Recommendation

**Quality Gate Recommendation:** CONCERNS (conditional PASS)

**Rationale:**
- One critical risk (TECH-001) requires comprehensive testing and validation
- Two high risks (OPS-001, DATA-001) need explicit mitigation
- Story is feasible but requires careful execution

**Conditions for PASS:**
1. All unit tests pass (especially TECH-001 related)
2. Integration tests pass on WSL+Windows environment
3. Error messages tested for clarity (OPS-001, TECH-002)
4. JSON serialization strategy documented and tested (DATA-001)
5. Documentation includes troubleshooting guide

**Development Focus:**
- Prioritize robust error handling (don't just happy-path)
- Test all failure modes explicitly
- Use Story 1.0 learnings to avoid known issues (INFO messages)
- Document Windows environment setup requirements clearly

---

**End of Risk Profile**
