# Test Design: Story 1.2 - Integrate Norgate Data API via Windows Python Bridge

**Date:** 2025-12-04
**Designer:** Quinn (Test Architect)
**Story:** 1.2 - Integrate Norgate Data API via Windows Python Bridge
**Risk Profile:** docs/qa/assessments/1.2-risk-20251204.md

---

## Test Strategy Overview

- **Total test scenarios:** 16
- **Unit tests:** 9 (56%)
- **Integration tests:** 7 (44%)
- **E2E tests:** 0 (0%)
- **Priority distribution:** P0: 11, P1: 3, P2: 2, P3: 0

**Strategy Rationale:**

This story focuses on foundational infrastructure (Windows Python bridge) with complex subprocess communication. The test strategy emphasizes:

1. **Unit test dominance**: Bridge logic is pure I/O orchestration - highly mockable and testable at unit level
2. **No E2E tests**: No user-facing functionality yet - this is infrastructure for future stories
3. **High P0 coverage**: Subprocess communication is critical infrastructure; failure blocks all downstream Epic 1 stories
4. **Risk mitigation focus**: All identified critical and high risks (TECH-001, OPS-001, DATA-001) have direct test coverage

---

## Test Scenarios by Acceptance Criteria

### AC1: norgatedata Python Package is Installed and Importable

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                            | Justification                                                     | Risk Coverage |
| ------------ | ----------- | -------- | -------------------------------------------------------- | ----------------------------------------------------------------- | ------------- |
| 1.2-INT-001  | Integration | P0       | Verify norgatedata package is importable via bridge      | Package availability is prerequisite for all operations           | TECH-001      |
| 1.2-INT-002  | Integration | P1       | Verify norgatedata version matches requirements (1.0.74) | Version mismatch could cause API compatibility issues             | TECH-002      |
| 1.2-UNIT-001 | Unit        | P0       | Verify bridge handles norgatedata import error           | Must provide clear error if package not installed in Windows side | OPS-001       |

**Coverage Summary:** 3 tests (2 P0, 1 P1)

---

### AC2: Windows Python Bridge Module Implements Subprocess-Based NDU Communication

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                                       | Justification                                                      | Risk Coverage |
| ------------ | ----------- | -------- | ------------------------------------------------------------------- | ------------------------------------------------------------------ | ------------- |
| 1.2-UNIT-002 | Unit        | P0       | Verify execute_norgate_code() constructs subprocess call correctly  | Core bridge function - must build correct python.exe command       | TECH-001      |
| 1.2-UNIT-003 | Unit        | P0       | Verify execute_norgate_code() parses JSON from subprocess stdout    | JSON parsing is critical for data transfer                         | DATA-001      |
| 1.2-UNIT-004 | Unit        | P0       | Verify execute_norgate_code() handles norgatedata INFO messages     | Known issue from Story 1.0 - must parse only last line            | DATA-002      |
| 1.2-UNIT-005 | Unit        | P0       | Verify execute_norgate_code() raises WindowsPythonNotFoundError     | Clear error when python.exe not in PATH                            | TECH-002      |
| 1.2-UNIT-006 | Unit        | P0       | Verify execute_norgate_code() raises NorgateBridgeError on timeout  | Timeout handling prevents hanging operations                       | PERF-001      |
| 1.2-UNIT-007 | Unit        | P0       | Verify execute_norgate_code() logs all bridge operations            | Observability for debugging subprocess issues                      | OPS-002       |
| 1.2-INT-003  | Integration | P0       | Verify bridge successfully executes simple Python code via Windows  | Validates subprocess communication in real environment             | TECH-001      |
| 1.2-INT-004  | Integration | P1       | Verify bridge handles concurrent requests without deadlocks         | Performance and resource management validation                     | PERF-001      |

**Coverage Summary:** 8 tests (7 P0, 1 P1)

---

### AC3: Basic Connection Test Successfully Retrieves Sample Ticker's Price Data via Bridge

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                                  | Justification                                              | Risk Coverage |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------------------- | ------------- |
| 1.2-UNIT-008 | Unit        | P0       | Verify fetch_price_data() constructs correct Norgate API call  | Helper function must generate valid norgatedata code       | DATA-001      |
| 1.2-UNIT-009 | Unit        | P0       | Verify fetch_price_data() parses DataFrame schema correctly    | DataFrame deserialization must preserve types and columns  | DATA-001      |
| 1.2-INT-005  | Integration | P0       | Verify fetch_price_data() retrieves AAPL data with NDU running | End-to-end validation of bridge + NDU + norgatedata stack | TECH-001      |
| 1.2-INT-006  | Integration | P0       | Verify retrieved data has expected schema (Date, OHLCV)        | Data quality validation against documented schema          | DATA-001      |
| 1.2-INT-007  | Integration | P2       | Verify fetch_price_data() handles different adjustment types   | Feature coverage for CAPITAL vs TOTALRETURN adjustments    | N/A           |

**Coverage Summary:** 5 tests (4 P0, 0 P1, 1 P2)

---

### AC4: Error Handling Provides Clear Messages if NDU is Not Running or Accessible

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                                         | Justification                                           | Risk Coverage |
| ------------ | ----------- | -------- | --------------------------------------------------------------------- | ------------------------------------------------------- | ------------- |
| 1.2-UNIT-010 | Unit        | P0       | Verify execute_norgate_code() raises NDUNotRunningError with message  | Clear error message guides user to start NDU            | OPS-001       |
| 1.2-UNIT-011 | Unit        | P0       | Verify check_ndu_status() detects NDU not running                     | Proactive status check before data operations           | OPS-001       |
| 1.2-INT-008  | Integration | P0       | Verify bridge error messages are actionable when NDU stopped          | User experience validation - can user fix the problem?  | OPS-002       |

**Coverage Summary:** 3 tests (3 P0)

---

### AC5: Documentation Explains Bridge Architecture and NDU Prerequisites

**Note:** Documentation is not test-executable via automated tests. Manual review required.

**Manual Validation Checklist:**

- [ ] `docs/architecture/windows-python-bridge.md` exists and explains subprocess pattern
- [ ] Documentation covers NDU prerequisites (Windows, authenticated subscription)
- [ ] Troubleshooting guide included for common errors
- [ ] Code examples provided for bridge usage
- [ ] Windows Python PATH requirements documented

**Validation Method:** Documentation review by dev team and QA

---

### AC6: Unit Test Verifies Bridge Communication Using Mock Subprocess Responses

**Note:** This AC is meta (tests testing tests). Coverage provided by unit test scenarios above.

**Validation Method:** All unit tests in 1.2-UNIT-* series use mock subprocess responses to validate bridge communication patterns.

---

## Risk Coverage Matrix

Maps test scenarios to identified risks from risk profile (1.2-risk-20251204.md).

| Risk ID  | Description                           | Severity | Test Coverage                                                 | Coverage Adequacy |
| -------- | ------------------------------------- | -------- | ------------------------------------------------------------- | ----------------- |
| TECH-001 | Subprocess communication failure      | Critical | 1.2-UNIT-002, 1.2-UNIT-003, 1.2-INT-001, 1.2-INT-003, 1.2-INT-005 | ✅ Comprehensive  |
| OPS-001  | NDU not running                       | High     | 1.2-UNIT-001, 1.2-UNIT-010, 1.2-UNIT-011, 1.2-INT-008        | ✅ Comprehensive  |
| DATA-001 | JSON serialization failures           | High     | 1.2-UNIT-003, 1.2-UNIT-008, 1.2-UNIT-009, 1.2-INT-006        | ✅ Comprehensive  |
| PERF-001 | Subprocess timeout                    | Medium   | 1.2-UNIT-006, 1.2-INT-004                                     | ✅ Adequate       |
| TECH-002 | Windows Python not in PATH            | Medium   | 1.2-UNIT-005, 1.2-INT-002                                     | ✅ Adequate       |
| DATA-002 | Norgatedata INFO messages             | Medium   | 1.2-UNIT-004                                                  | ✅ Adequate       |
| SEC-001  | Command injection                     | Low      | Code review only                                              | ✅ Adequate       |
| OPS-002  | Inadequate error messages             | Low      | 1.2-UNIT-007, 1.2-INT-008                                     | ✅ Adequate       |

**Coverage Assessment:** All identified risks have appropriate test coverage. Critical and high risks have multiple test scenarios ensuring defense-in-depth validation.

---

## Detailed Test Scenarios

### Unit Tests

#### 1.2-UNIT-001: Bridge Handles Norgatedata Import Error

**Priority:** P0
**Acceptance Criteria:** AC1
**Risk Coverage:** OPS-001

**Description:**
Verify that `execute_norgate_code()` raises a clear error when norgatedata package is not installed in Windows Python environment.

**Test Steps:**
1. Mock subprocess.run to return stderr: "ModuleNotFoundError: No module named 'norgatedata'"
2. Call `execute_norgate_code()`
3. Assert `NorgateBridgeError` raised with message mentioning norgatedata installation

**Expected Outcome:**
Clear error message: "norgatedata package not found in Windows Python. Install via: pip install norgatedata==1.0.74"

**Justification:**
Package availability is a prerequisite. Clear error message enables quick resolution. (Test Level Framework: Unit - Error handling in isolated component)

---

#### 1.2-UNIT-002: Execute_norgate_code() Constructs Subprocess Call Correctly

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** TECH-001

**Description:**
Verify that `execute_norgate_code()` constructs the correct subprocess command with proper Python code wrapper.

**Test Steps:**
1. Mock subprocess.run to capture call arguments
2. Call `execute_norgate_code("norgatedata.version()")`
3. Assert subprocess.run called with: `['python.exe', '-c', <wrapper_code>]`
4. Assert wrapper includes: `import json`, `import norgatedata`, `print(json.dumps(result))`

**Expected Outcome:**
Subprocess called with correctly formatted Python code including JSON serialization wrapper.

**Justification:**
Core bridge mechanism. Incorrect subprocess construction causes complete failure. (Test Level Framework: Unit - Pure function testing)

---

#### 1.2-UNIT-003: Execute_norgate_code() Parses JSON from Subprocess Stdout

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** DATA-001

**Description:**
Verify that `execute_norgate_code()` correctly parses JSON from subprocess stdout, handling various data types.

**Test Steps:**
1. Mock subprocess.run to return stdout: `'{"version": "1.0.74", "date": "2023-12-04", "count": 12225}'`
2. Call `execute_norgate_code()`
3. Assert result is dict: `{"version": "1.0.74", "date": "2023-12-04", "count": 12225}`
4. Test with various JSON types: string, number, array, nested objects

**Expected Outcome:**
JSON correctly parsed into Python dict with proper type preservation.

**Justification:**
JSON parsing is the core data transfer mechanism. Failures cause data corruption or crashes. (Test Level Framework: Unit - Data transformation testing)

---

#### 1.2-UNIT-004: Execute_norgate_code() Handles Norgatedata INFO Messages

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** DATA-002

**Description:**
Verify that `execute_norgate_code()` correctly parses JSON when norgatedata INFO messages are present in stdout.

**Test Steps:**
1. Mock subprocess.run to return stdout with INFO messages:
   ```
   INFO: Norgate Data Updater connection established
   INFO: Retrieving data for AAPL
   {"symbol": "AAPL", "rows": 252}
   ```
2. Call `execute_norgate_code()`
3. Assert only last line parsed: `{"symbol": "AAPL", "rows": 252}`
4. Assert INFO messages ignored

**Expected Outcome:**
JSON correctly extracted from last line, INFO messages do not interfere with parsing.

**Justification:**
Known issue from Story 1.0. Must validate mitigation strategy (parse only last line). (Test Level Framework: Unit - Input validation)

---

#### 1.2-UNIT-005: Execute_norgate_code() Raises WindowsPythonNotFoundError

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** TECH-002

**Description:**
Verify that `execute_norgate_code()` raises clear error when Windows Python is not in PATH.

**Test Steps:**
1. Mock subprocess.run to raise FileNotFoundError
2. Call `execute_norgate_code()`
3. Assert `WindowsPythonNotFoundError` raised
4. Assert error message includes troubleshooting steps (check PATH, install Python)

**Expected Outcome:**
Clear error with actionable resolution: "Windows Python (python.exe) not found. Ensure Windows Python is installed and in WSL PATH."

**Justification:**
Environment validation prevents confusing errors. (Test Level Framework: Unit - Error handling in isolated component)

---

#### 1.2-UNIT-006: Execute_norgate_code() Raises NorgateBridgeError on Timeout

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** PERF-001

**Description:**
Verify that `execute_norgate_code()` raises error when subprocess exceeds timeout.

**Test Steps:**
1. Mock subprocess.run to raise subprocess.TimeoutExpired(cmd=['python.exe'], timeout=30)
2. Call `execute_norgate_code(timeout=30)`
3. Assert `NorgateBridgeError` raised with message mentioning timeout
4. Assert timeout value included in error message

**Expected Outcome:**
Error raised: "Bridge operation timed out after 30 seconds. Check if NDU is responding."

**Justification:**
Timeout handling prevents hanging operations. Critical for user experience. (Test Level Framework: Unit - Error handling)

---

#### 1.2-UNIT-007: Execute_norgate_code() Logs All Bridge Operations

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** OPS-002

**Description:**
Verify that `execute_norgate_code()` logs operations with structured logging (structlog).

**Test Steps:**
1. Configure test log capture
2. Mock subprocess.run to succeed
3. Call `execute_norgate_code("norgatedata.version()")`
4. Assert logs contain: `event="executing_norgate_code"`, `code_length=<n>`
5. Assert logs contain: `event="norgate_code_executed"`, `success=True`
6. Test failure path: Assert error logged with full context

**Expected Outcome:**
All bridge operations logged with structured context for debugging.

**Justification:**
Observability is critical for debugging subprocess issues. (Test Level Framework: Unit - Component behavior validation)

---

#### 1.2-UNIT-008: Fetch_price_data() Constructs Correct Norgate API Call

**Priority:** P0
**Acceptance Criteria:** AC3
**Risk Coverage:** DATA-001

**Description:**
Verify that `fetch_price_data()` constructs correct norgatedata API call for price data retrieval.

**Test Steps:**
1. Mock `execute_norgate_code()` to capture code parameter
2. Call `fetch_price_data(symbol="AAPL", start_date=date(2023, 1, 1), end_date=date(2023, 12, 31), adjustment="TOTALRETURN")`
3. Assert code includes: `norgatedata.price_data("AAPL", ...)` with correct parameters
4. Assert adjustment type passed correctly
5. Assert date format correct (ISO 8601 or norgatedata format)

**Expected Outcome:**
Generated code correctly calls norgatedata API with all parameters.

**Justification:**
Helper function correctness ensures data fetched as expected. (Test Level Framework: Unit - Pure function testing)

---

#### 1.2-UNIT-009: Fetch_price_data() Parses DataFrame Schema Correctly

**Priority:** P0
**Acceptance Criteria:** AC3
**Risk Coverage:** DATA-001

**Description:**
Verify that `fetch_price_data()` correctly deserializes bridge response into pandas DataFrame with expected schema.

**Test Steps:**
1. Mock `execute_norgate_code()` to return JSON DataFrame representation
2. Call `fetch_price_data(symbol="AAPL")`
3. Assert result is pandas DataFrame
4. Assert columns: ['date', 'symbol', 'open', 'high', 'low', 'close', 'volume']
5. Assert dtypes: date=datetime64[ns], close=float64, volume=int64
6. Assert date column is index

**Expected Outcome:**
DataFrame with correct schema matching data models specification (docs/architecture/data-models.md:6-20).

**Justification:**
Schema validation ensures data integrity for downstream processing. (Test Level Framework: Unit - Data transformation testing)

---

#### 1.2-UNIT-010: Execute_norgate_code() Raises NDUNotRunningError with Message

**Priority:** P0
**Acceptance Criteria:** AC4
**Risk Coverage:** OPS-001

**Description:**
Verify that `execute_norgate_code()` raises clear error when NDU is not running.

**Test Steps:**
1. Mock subprocess.run to return: returncode=1, stderr="Error: NDU is not running"
2. Call `execute_norgate_code()`
3. Assert `NDUNotRunningError` raised
4. Assert error message: "Norgate Data Updater is not running. Please start NDU on Windows and ensure you're logged in."

**Expected Outcome:**
Clear, actionable error message guiding user to resolution.

**Justification:**
Clear error messages reduce support burden and improve developer experience. (Test Level Framework: Unit - Error handling)

---

#### 1.2-UNIT-011: Check_ndu_status() Detects NDU Not Running

**Priority:** P0
**Acceptance Criteria:** AC4
**Risk Coverage:** OPS-001

**Description:**
Verify that `check_ndu_status()` proactively detects when NDU is not running.

**Test Steps:**
1. Mock `execute_norgate_code()` to raise `NDUNotRunningError`
2. Call `check_ndu_status()`
3. Assert function returns False
4. Mock `execute_norgate_code()` to succeed
5. Call `check_ndu_status()`
6. Assert function returns True

**Expected Outcome:**
Boolean result correctly indicates NDU availability.

**Justification:**
Proactive status check enables graceful degradation and clear error reporting. (Test Level Framework: Unit - Component behavior)

---

### Integration Tests

#### 1.2-INT-001: Verify Norgatedata Package is Importable via Bridge

**Priority:** P0
**Acceptance Criteria:** AC1
**Risk Coverage:** TECH-001

**Description:**
Verify that norgatedata package can be imported through the Windows Python bridge in actual environment.

**Test Steps:**
1. Call `execute_norgate_code("import norgatedata; norgatedata.version()")`
2. Assert result contains version string (e.g., "1.0.74")
3. Assert no import errors

**Expected Outcome:**
norgatedata successfully imported and version retrieved.

**Environment Requirements:**
- Windows Python with norgatedata 1.0.74 installed
- python.exe in WSL PATH

**Justification:**
Package availability is prerequisite. Integration test validates actual environment setup. (Test Level Framework: Integration - External dependency validation)

---

#### 1.2-INT-002: Verify Norgatedata Version Matches Requirements

**Priority:** P1
**Acceptance Criteria:** AC1
**Risk Coverage:** TECH-002

**Description:**
Verify that installed norgatedata version matches required version (1.0.74).

**Test Steps:**
1. Call `execute_norgate_code("import norgatedata; norgatedata.version()")`
2. Assert version == "1.0.74"
3. If version mismatch, log warning with upgrade instructions

**Expected Outcome:**
Version validation passes or clear upgrade instructions provided.

**Environment Requirements:**
- Windows Python with norgatedata installed

**Justification:**
Version compatibility prevents API breaking changes. (Test Level Framework: Integration - Dependency validation)

---

#### 1.2-INT-003: Verify Bridge Successfully Executes Simple Python Code via Windows

**Priority:** P0
**Acceptance Criteria:** AC2
**Risk Coverage:** TECH-001

**Description:**
Verify end-to-end subprocess communication with simple Python code execution.

**Test Steps:**
1. Call `execute_norgate_code("2 + 2")`
2. Assert result == 4
3. Call `execute_norgate_code("{'key': 'value'}")`
4. Assert result == {"key": "value"}
5. Verify JSON serialization/deserialization round-trip

**Expected Outcome:**
Simple Python expressions execute correctly through bridge with correct results.

**Environment Requirements:**
- Windows Python (python.exe) in WSL PATH

**Justification:**
Validates core bridge mechanism without NDU dependency. Faster feedback than full Norgate tests. (Test Level Framework: Integration - Component interaction)

---

#### 1.2-INT-004: Verify Bridge Handles Concurrent Requests Without Deadlocks

**Priority:** P1
**Acceptance Criteria:** AC2
**Risk Coverage:** PERF-001

**Description:**
Verify that multiple concurrent bridge operations do not cause deadlocks or resource leaks.

**Test Steps:**
1. Use threading/asyncio to make 10 concurrent calls to `execute_norgate_code()`
2. Assert all calls complete successfully
3. Assert no subprocess leaks (check process count before/after)
4. Measure total execution time (should be < 10x single call due to parallelism)

**Expected Outcome:**
Concurrent operations succeed without deadlocks or resource exhaustion.

**Environment Requirements:**
- Windows Python (python.exe) in WSL PATH

**Justification:**
Validates resource management for future parallel data fetching. (Test Level Framework: Integration - Performance under concurrency)

---

#### 1.2-INT-005: Verify Fetch_price_data() Retrieves AAPL Data with NDU Running

**Priority:** P0
**Acceptance Criteria:** AC3
**Risk Coverage:** TECH-001

**Description:**
End-to-end validation of full bridge + NDU + norgatedata stack with actual price data retrieval.

**Test Steps:**
1. Ensure NDU is running (use `check_ndu_status()`)
2. Call `fetch_price_data(symbol="AAPL", start_date=date(2023, 1, 1), end_date=date(2023, 12, 31))`
3. Assert DataFrame returned (not None)
4. Assert DataFrame not empty (rows > 0)
5. Assert symbol column contains "AAPL"
6. Log retrieval time for performance baseline

**Expected Outcome:**
AAPL price data retrieved successfully with reasonable performance (~7ms per Story 1.0 benchmark).

**Environment Requirements:**
- Windows environment
- NDU running and authenticated
- Windows Python with norgatedata 1.0.74
- Russell 3000 C&P subscription active

**Justification:**
Critical path validation - proves entire bridge stack works end-to-end. (Test Level Framework: Integration - Multi-component flow)

---

#### 1.2-INT-006: Verify Retrieved Data Has Expected Schema

**Priority:** P0
**Acceptance Criteria:** AC3
**Risk Coverage:** DATA-001

**Description:**
Validate that fetched price data conforms to documented schema specification.

**Test Steps:**
1. Call `fetch_price_data(symbol="AAPL")`
2. Assert columns present: ['date', 'symbol', 'open', 'high', 'low', 'close', 'volume']
3. Assert dtypes: date=datetime64[ns], open/high/low/close=float64, volume=int64
4. Assert no NaN values in price columns (open/high/low/close)
5. Assert date column is sorted ascending
6. Assert date column is index

**Expected Outcome:**
DataFrame schema matches specification (docs/architecture/data-models.md:6-20).

**Environment Requirements:**
- Windows environment with NDU running

**Justification:**
Data quality validation ensures downstream consumers can trust schema. (Test Level Framework: Integration - Data contract validation)

---

#### 1.2-INT-007: Verify Fetch_price_data() Handles Different Adjustment Types

**Priority:** P2
**Acceptance Criteria:** AC3
**Risk Coverage:** N/A

**Description:**
Verify that bridge correctly fetches data with different adjustment types (CAPITAL, TOTALRETURN).

**Test Steps:**
1. Fetch AAPL data with adjustment="CAPITAL"
2. Fetch AAPL data with adjustment="TOTALRETURN"
3. Assert both succeed
4. Assert TOTALRETURN prices account for dividends (prices differ from CAPITAL)
5. Assert TOTALRETURN includes dividend column

**Expected Outcome:**
Both adjustment types work correctly with documented differences.

**Environment Requirements:**
- Windows environment with NDU running

**Justification:**
Feature coverage for adjustment types. Lower priority as both use same bridge mechanism. (Test Level Framework: Integration - Feature variation)

---

#### 1.2-INT-008: Verify Bridge Error Messages Are Actionable When NDU Stopped

**Priority:** P0
**Acceptance Criteria:** AC4
**Risk Coverage:** OPS-002

**Description:**
User experience validation - verify error messages guide user to resolution.

**Test Steps:**
1. Stop NDU (manual step)
2. Call `fetch_price_data(symbol="AAPL")`
3. Assert `NDUNotRunningError` raised
4. Verify error message includes:
   - Clear problem statement ("NDU is not running")
   - Resolution steps ("Please start NDU on Windows")
   - Authentication reminder ("ensure you're logged in")
5. Start NDU (manual step)
6. Retry `fetch_price_data()`
7. Assert now succeeds

**Expected Outcome:**
Error message enables user to self-resolve without documentation lookup.

**Environment Requirements:**
- Windows environment
- Ability to start/stop NDU

**Justification:**
Error message quality directly impacts developer experience. Integration test validates real error flow. (Test Level Framework: Integration - User experience validation)

---

## Test Execution Strategy

### Recommended Execution Order

1. **Phase 1: Fast Feedback (Unit Tests P0)** - ~10 seconds
   - Run all 1.2-UNIT-* tests
   - If any fail, halt (bridge logic broken)

2. **Phase 2: Environment Validation (Integration P0 without NDU)** - ~5 seconds
   - 1.2-INT-001: Verify norgatedata importable
   - 1.2-INT-003: Verify basic bridge communication
   - If these fail, environment setup issue (not code issue)

3. **Phase 3: Full Integration (Integration P0 with NDU)** - ~30 seconds
   - 1.2-INT-005: Fetch AAPL data
   - 1.2-INT-006: Validate schema
   - 1.2-INT-008: Test error messages with NDU stopped
   - These require manual NDU control

4. **Phase 4: Secondary Coverage (P1 and P2)** - ~60 seconds
   - 1.2-INT-002: Version check
   - 1.2-INT-004: Concurrent requests
   - 1.2-INT-007: Adjustment types

### CI/CD Integration

**Pre-commit Hook:**
- Run all unit tests (1.2-UNIT-*) - must pass

**CI Pipeline (WSL environment only):**
- Run unit tests
- Skip integration tests (require Windows + NDU)
- Report coverage metrics

**Manual QA Gate (Windows environment):**
- Run all integration tests with NDU
- Validate error message quality
- Performance baseline measurement

**Rationale:** Bridge requires Windows environment with NDU. Full integration testing must be manual or require Windows CI runner.

---

## Test Data Requirements

### Mock Data for Unit Tests

**Valid subprocess outputs:**
```json
// Success with INFO messages
INFO: Norgate Data Updater connection established
{"symbol": "AAPL", "rows": 252, "start_date": "2023-01-03", "end_date": "2023-12-29"}

// DataFrame JSON representation
{
  "data": [
    {"date": "2023-01-03", "open": 125.07, "high": 125.27, "low": 124.17, "close": 125.07, "volume": 112117471},
    {"date": "2023-01-04", "open": 126.89, "high": 128.66, "low": 125.08, "close": 126.36, "volume": 89113631}
  ]
}
```

**Error outputs:**
```
// NDU not running
stderr: "Error: NDU is not running or not accessible"
returncode: 1

// Module not found
stderr: "ModuleNotFoundError: No module named 'norgatedata'"
returncode: 1

// Timeout
subprocess.TimeoutExpired(cmd=['python.exe', '-c', '...'], timeout=30)
```

### Integration Test Data

**Test Symbols:**
- **AAPL** (Apple Inc.): Active, liquid, complete history, dividend-paying
- **MSFT** (Microsoft): Active, liquid, complete history, dividend-paying

**Date Ranges:**
- **Short range**: 2023-01-01 to 2023-12-31 (1 year, ~252 trading days, fast test)
- **Medium range**: 2020-01-01 to 2023-12-31 (4 years, slower but more thorough)

**Adjustment Types:**
- **CAPITAL**: Price adjustments for splits only
- **TOTALRETURN**: Price adjustments for splits and dividends

---

## Coverage Analysis

### Acceptance Criteria Coverage

| AC  | Description                                | Tests | P0 Tests | Coverage |
| --- | ------------------------------------------ | ----- | -------- | -------- |
| AC1 | Package installed and importable          | 3     | 2        | ✅ Full   |
| AC2 | Bridge implements subprocess communication | 8     | 7        | ✅ Full   |
| AC3 | Connection test retrieves data             | 5     | 4        | ✅ Full   |
| AC4 | Error handling with clear messages         | 3     | 3        | ✅ Full   |
| AC5 | Documentation (manual review)              | N/A   | N/A      | Manual   |
| AC6 | Unit tests (meta AC)                       | N/A   | N/A      | Covered  |

**Overall AC Coverage:** 6/6 (100%)

### Risk Coverage

| Risk Level | Risks | Tests Mapped | Coverage |
| ---------- | ----- | ------------ | -------- |
| Critical   | 1     | 5            | ✅ Strong |
| High       | 2     | 8            | ✅ Strong |
| Medium     | 3     | 6            | ✅ Good   |
| Low        | 2     | 2            | ✅ Basic  |

**Overall Risk Coverage:** 8/8 (100%)

### Code Coverage Targets

Based on priority distribution and test type:

- **Unit test coverage:** Target >85% for `src/momo/data/bridge.py`
- **Integration coverage:** All public API functions (`fetch_price_data`, `check_ndu_status`, etc.)
- **Error paths:** 100% coverage of exception handling (critical for bridge reliability)

---

## Test Maintenance Considerations

### Test Stability

**Stable (low maintenance):**
- All unit tests (mocked, no external dependencies)
- Integration tests without NDU (basic bridge validation)

**Moderate stability:**
- Integration tests with NDU (require Windows environment setup)
- Schema validation tests (may need updates if data model evolves)

**Brittle (high maintenance):**
- None identified (no E2E tests, no UI tests)

### Test Execution Requirements

**Developer Workstation (WSL):**
- Can run: All unit tests
- Cannot run: Integration tests requiring NDU
- Setup time: None (mock-based)

**Windows Environment (Manual QA):**
- Can run: All tests (unit + integration)
- Requires: NDU installation, authentication, Windows Python setup
- Setup time: ~15 minutes (first time)

### Test Data Management

**Mock data:**
- Stored in test files (inline or fixtures)
- Version controlled
- No external dependencies

**Live data:**
- Fetched from NDU during integration tests
- Requires active Norgate subscription
- Subject to market data availability

---

## Quality Gates

### Gate: Unit Tests Must Pass

**Condition:** All 1.2-UNIT-* tests pass with >85% code coverage

**Rationale:** Unit tests validate core bridge logic without external dependencies. Must be green before integration testing.

**Failure Action:** Fix code, do not proceed to integration tests.

---

### Gate: Critical Integration Tests Must Pass

**Condition:** All P0 integration tests pass (1.2-INT-001, 1.2-INT-003, 1.2-INT-005, 1.2-INT-006, 1.2-INT-008)

**Rationale:** P0 integration tests validate bridge works in real environment with NDU.

**Failure Action:** Investigate environment setup or bridge implementation. Do not merge story until resolved.

---

### Gate: Error Messages Are Actionable

**Condition:** Manual validation that error messages in 1.2-INT-008 enable self-service resolution

**Rationale:** Developer experience is critical for internal tooling. Poor error messages increase support burden.

**Failure Action:** Revise error messages, update documentation, retest.

---

## Test Debt and Future Improvements

### Known Limitations

1. **No chaos testing automation**: Chaotic scenarios (kill NDU mid-request, corrupt JSON) are manual
2. **No performance regression tests**: No automated tracking of bridge operation duration over time
3. **No Windows CI integration**: All integration tests require manual execution on Windows

### Future Test Enhancements

**Post-Story 1.2:**

1. **Add chaos testing framework**
   - Automated NDU kill/restart during operations
   - Network latency injection
   - Resource exhaustion scenarios

2. **Performance benchmarking**
   - Automated performance tests with alerting (p95 > 10 seconds)
   - Compare against Story 1.0 baseline (~7ms per symbol)

3. **Windows CI runner**
   - Automate integration tests in CI pipeline
   - Require NDU test environment setup

4. **Property-based testing**
   - Use Hypothesis for bridge input fuzzing
   - Test arbitrary JSON structures, edge case dates, etc.

---

## Test Review Checklist

Before finalizing test implementation, verify:

- [x] Every AC has test coverage
- [x] All P0 tests identified and justified
- [x] Test levels appropriate (unit vs integration)
- [x] No duplicate coverage across levels
- [x] All risks from risk profile mapped to tests
- [x] Test IDs follow naming convention (1.2-UNIT-001, etc.)
- [x] Environment requirements documented
- [x] Execution order optimized for fast feedback
- [x] Quality gates defined with clear pass/fail criteria

---

## Appendix: Test Design YAML Block

For inclusion in quality gate decision:

```yaml
test_design:
  scenarios_total: 16
  by_level:
    unit: 9
    integration: 7
    e2e: 0
  by_priority:
    p0: 11
    p1: 3
    p2: 2
    p3: 0
  coverage_gaps: []
  risk_coverage:
    critical: 5
    high: 8
    medium: 6
    low: 2
  execution_requirements:
    unit_tests: "WSL environment (no NDU required)"
    integration_tests: "Windows environment with NDU running"
    estimated_unit_time: "10 seconds"
    estimated_integration_time: "120 seconds"
```

---

## Trace Requirements Reference

For use by `trace-requirements` task:

**Test design document:** `docs/qa/assessments/1.2-test-design-20251204.md`
**P0 tests identified:** 11
**Total test scenarios:** 16
**Ready for traceability mapping:** Yes

---

**End of Test Design Document**
